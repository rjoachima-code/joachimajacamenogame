# Jacamenoville Unity Build Pipeline
# Builds and tests the Unity project on push/PR

name: Unity Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      build_platform:
        description: 'Build platform'
        required: true
        default: 'StandaloneWindows64'
        type: choice
        options:
          - StandaloneWindows64
          - StandaloneOSX
          - StandaloneLinux64
          - Android
          - iOS

env:
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
  PROJECT_PATH: 'My project (4)'

jobs:
  # Code quality check
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Check for common issues
        run: |
          echo "Checking for common Unity issues..."
          # Check for .meta files
          find . -name "*.cs" -type f | while read file; do
            meta_file="${file}.meta"
            if [ ! -f "$meta_file" ]; then
              echo "Warning: Missing meta file for $file"
            fi
          done
          echo "Code quality check complete"

  # Main build job
  build:
    name: Build for ${{ matrix.targetPlatform }}
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        targetPlatform:
          - StandaloneWindows64
          # - StandaloneOSX
          # - StandaloneLinux64
          # - Android
          # - iOS
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: |
            Library
            ${{ env.PROJECT_PATH }}/Library
          key: Library-${{ matrix.targetPlatform }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ matrix.targetPlatform }}-
            Library-

      - name: Build Unity Project
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
          projectPath: ${{ env.PROJECT_PATH }}
          buildsPath: build
          buildName: Jacamenoville
          versioning: Semantic

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Build-${{ matrix.targetPlatform }}
          path: build/${{ matrix.targetPlatform }}
          retention-days: 14

  # Run Unity Tests
  test:
    name: Run Unity Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: |
            Library
            ${{ env.PROJECT_PATH }}/Library
          key: Library-Test-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Test-
            Library-

      - name: Run Edit Mode Tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          testMode: editmode
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: Edit Mode Test Results

      - name: Run Play Mode Tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          testMode: playmode
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: Play Mode Test Results

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Test-Results
          path: artifacts
          retention-days: 14

  # Notify on completion
  notify:
    name: Build Notification
    runs-on: ubuntu-latest
    needs: [build, test]
    if: always()
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build.result }}" == "success" ] && [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ Build and tests passed successfully!"
          else
            echo "❌ Build or tests failed. Check the logs for details."
            exit 1
          fi
